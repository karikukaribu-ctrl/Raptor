<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>EPS — Questionnaire → Rapport</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#0f1115;color:#e9edf5}
    header{position:sticky;top:0;background:rgba(15,17,21,.9);backdrop-filter:blur(10px);padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08)}
    main{max-width:980px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px}
    .nav{display:flex;gap:8px;flex-wrap:wrap}
    button{background:rgba(255,255,255,.06);color:#e9edf5;border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:10px 12px;cursor:pointer}
    button:hover{background:rgba(255,255,255,.10)}
    .active{outline:2px solid rgba(255,255,255,.25)}
    label{display:block;margin:10px 0 6px;color:#a8b0bd}
    input[type="text"], textarea{
      width:100%;box-sizing:border-box;background:rgba(0,0,0,.25);color:#e9edf5;
      border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px
    }
    .opt{display:flex;gap:10px;align-items:flex-start;margin:8px 0}
    .opt input{margin-top:3px}
    .muted{color:#a8b0bd}
    .split{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:920px){.split{grid-template-columns:1.1fr .9fr}}
    .small{font-size:12px}
  </style>
</head>
<body>
<header>
  <div class="row" style="align-items:center;justify-content:space-between">
    <div>
      <div style="font-weight:700">EPS — Questionnaire → Rapport</div>
      <div class="muted small">Local-only • multi-choix + notes • génération texte</div>
    </div>
    <div class="row">
      <button id="btnExport">Exporter JSON</button>
      <button id="btnReset">Reset</button>
    </div>
  </div>
</header>

<main class="split">
  <section class="card">
    <div class="nav" id="nav"></div>
    <div id="section"></div>
  </section>

  <aside class="card">
    <div style="display:flex;gap:10px;align-items:center;justify-content:space-between">
      <div style="font-weight:700">Rapport généré</div>
      <button id="btnCopy">Copier</button>
    </div>
    <div class="muted small" style="margin:6px 0 10px">
      Tu peux créer une version “trame” + une version “narrative” en changeant les templates.
    </div>
    <textarea id="report" rows="28" placeholder="Le rapport apparaîtra ici…"></textarea>
  </aside>
</main>

<script>
/** ============
 *  1) Définition du formulaire (EXEMPLE MINIMAL)
 *  -> Ajoute ici toutes les sections/items du PDF
 *  ============ */
const FORM = [
  {
    id: "prise_en_charge",
    title: "1. Prise en charge",
    blocks: [
      { type:"text", id:"motif", label:"Motif / plainte principale (patient et/ou entourage)",
        report: (v)=> v?.trim() ? `Motif/Plainte : ${v.trim()}.` : "" },
      { type:"single", id:"cadre", label:"Cadre de soins",
        options:["Soins libres","Soins sans consentement"],
        report: (v)=> v ? `Cadre : ${v}.` : "" },
      { type:"text", id:"referent", label:"Psychiatre référent (nom)",
        report: (v)=> v?.trim() ? `Référent : ${v.trim()}.` : "" }
    ]
  },
  {
    id: "mse_pensee",
    title: "6. Entretien — Pensées (exemple)",
    blocks: [
      { type:"single", id:"rythme_pensee", label:"Rythme de la pensée",
        options:["Normal","Diminué","Augmenté"],
        report: (v)=> v ? `Pensée — rythme : ${v}.` : "" },
      { type:"multi", id:"contenu_pensee", label:"Contenu (cocher si présent)",
        options:["Idées délirantes","Soucis/inquiétudes excessifs","Idées obsessionnelles","Idées de mort / suicide"],
        report: (arr)=> (arr?.length? `Pensée — contenu : ${arr.join(", ")}.` : "") },
      { type:"text", id:"notes_pensee", label:"Notes (ex : thèmes, mécanismes, retentissement)",
        report: (v)=> v?.trim()? `Pensée — notes : ${v.trim()}.` : "" }
    ]
  }
];

/** ============
 *  2) Stockage local
 *  ============ */
const KEY = "eps_form_v1";
const state = load() || { sectionId: FORM[0].id, answers: {} };

function load(){
  try{ return JSON.parse(localStorage.getItem(KEY)); }catch{ return null; }
}
function save(){
  localStorage.setItem(KEY, JSON.stringify(state));
}

/** ============
 *  3) Rendu UI
 *  ============ */
const navEl = document.getElementById("nav");
const sectionEl = document.getElementById("section");
const reportEl = document.getElementById("report");

function renderNav(){
  navEl.innerHTML = "";
  for(const s of FORM){
    const b = document.createElement("button");
    b.textContent = s.title;
    if(s.id === state.sectionId) b.classList.add("active");
    b.onclick = ()=>{ state.sectionId = s.id; save(); render(); };
    navEl.appendChild(b);
  }
}

function setAnswer(id, value){
  state.answers[id] = value;
  save();
  renderReport();
}

function getAnswer(id){
  return state.answers[id];
}

function renderSection(){
  const s = FORM.find(x=>x.id===state.sectionId) || FORM[0];
  sectionEl.innerHTML = `<div style="font-weight:700;font-size:18px;margin:6px 0 12px">${s.title}</div>`;
  for(const block of s.blocks){
    const wrap = document.createElement("div");

    const lab = document.createElement("label");
    lab.textContent = block.label;
    wrap.appendChild(lab);

    const current = getAnswer(block.id);

    if(block.type === "text"){
      const ta = document.createElement(block.label.length>60 ? "textarea" : "textarea");
      ta.rows = 3;
      ta.value = current || "";
      ta.oninput = ()=> setAnswer(block.id, ta.value);
      wrap.appendChild(ta);
    }

    if(block.type === "boolean"){
      const opts = ["Non","Oui"];
      opts.forEach(val=>{
        const line = document.createElement("div"); line.className="opt";
        const input = document.createElement("input"); input.type="radio"; input.name=block.id;
        input.checked = (current===val);
        input.onchange = ()=> setAnswer(block.id, val);
        const span = document.createElement("div"); span.textContent = val;
        line.appendChild(input); line.appendChild(span);
        wrap.appendChild(line);
      });
    }

    if(block.type === "single"){
      (block.options||[]).forEach(val=>{
        const line = document.createElement("div"); line.className="opt";
        const input = document.createElement("input"); input.type="radio"; input.name=block.id;
        input.checked = (current===val);
        input.onchange = ()=> setAnswer(block.id, val);
        const span = document.createElement("div"); span.textContent = val;
        line.appendChild(input); line.appendChild(span);
        wrap.appendChild(line);
      });
    }

    if(block.type === "multi"){
      const arr = Array.isArray(current) ? current : [];
      (block.options||[]).forEach(val=>{
        const line = document.createElement("div"); line.className="opt";
        const input = document.createElement("input"); input.type="checkbox";
        input.checked = arr.includes(val);
        input.onchange = ()=>{
          const next = new Set(arr);
          input.checked ? next.add(val) : next.delete(val);
          setAnswer(block.id, Array.from(next));
        };
        const span = document.createElement("div"); span.textContent = val;
        line.appendChild(input); line.appendChild(span);
        wrap.appendChild(line);
      });
    }

    wrap.style.marginBottom = "14px";
    sectionEl.appendChild(wrap);
  }
}

function renderReport(){
  const lines = [];
  for(const s of FORM){
    const chunk = [];
    for(const b of s.blocks){
      const v = getAnswer(b.id);
      if(typeof b.report === "function"){
        const t = b.report(v);
        if(t) chunk.push(t);
      }
    }
    if(chunk.length){
      lines.push(`${s.title}\n${chunk.map(x=>"• "+x).join("\n")}`);
    }
  }
  reportEl.value = lines.join("\n\n").trim();
}

function render(){
  renderNav();
  renderSection();
  renderReport();
}

/** ============
 *  4) Boutons utilitaires
 *  ============ */
document.getElementById("btnCopy").onclick = async ()=>{
  try{
    await navigator.clipboard.writeText(reportEl.value || "");
  }catch(e){
    alert("Copie impossible (permissions navigateur).");
  }
};

document.getElementById("btnReset").onclick = ()=>{
  localStorage.removeItem(KEY);
  location.reload();
};

document.getElementById("btnExport").onclick = ()=>{
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "eps-reponses.json";
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
};

render();
</script>
</body>
</html>
